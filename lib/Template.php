<?phpclass Template extends Layout{    public $db       = false;    public $model    = false;    public $theme    = '';    public $template = false;    public static function clearCssJsCache($path = 'frontend')    {        $script = "rm -rf " . _BASEDIR . "var/cache/$path/*";        return system($script, $retval);    }    public function _templateInit()    {        $this->addHandle('default');        $this->configPrepare();        if ($this->theme == '') {            $this->theme = $this->getConfig('default/' . parent::$__area . '/theme');        }        if (parent::$cacheFolder == '') {            parent::$cacheFolder = $this->getConfig('path/var_cache');        }        if (parent::$skinBasePath == '') {            parent::$skinBasePath = $this->getConfig('path/skin');        }        $themePath = parent::$__area . "/" . $this->theme . "/";        parent::$skinPath = parent::$skinBasePath . "/" . $themePath;        parent::$themePath = _APPDIR . "design/" . $themePath;        parent::$templatePath = _APPDIR . "design/" . $themePath . "template/";        parent::$cacheUrl = parent::$cacheFolder . parent::$__area . "/";        parent::$cachePath = _BASEDIR . parent::$cacheUrl;        parent::$cacheJsonFile = parent::$cachePath . "cache.json";        if (!is_writable(_BASEDIR . parent::$skinPath)) {            $this->log("Please Check skin directory path is writable");        }    }    // For ajax kind of response    public function renderIntoString($view_file, $params = array())    {        ob_start();        $this->render($view_file, $params);        $_template_content = ob_get_contents();        ob_end_clean();        return $_template_content;    }    // For normal response    public function render($viewFile, $resultParams = array())    {        $this->prepareLayout();        $this->renderLayout();//        if (parent::$configData['css_compress'] == 1) {//            Helper::updateCacheFile(parent::$cacheJsonFile, parent::$cachedJson);//        }        if($this->getConfig('default/print_execution_order') == "1") {            parent::printAppFilesStack();        }    }    public function prepareXmlTemplates($type, $xmlObj)    {        foreach($xmlObj->$type as $xmlNode){            $name = $this->getXmlAttributeValue($xmlNode,'name');            $template = $this->getXmlAttributeValue($xmlNode,'template');            $this->templates[$name] = array("template" => $template,'block'=> $xmlNode);            if($xmlNode->$type != null){                $this->prepareXmlTemplates($type,$xmlNode);            }        }    }    public function updateXmlTemplates($type, $xmlObj)    {        foreach($xmlObj->$type as $xmlNode){            debug($xmlNode);            $name = $this->getXmlAttributeValue($xmlNode,'name');            $template = $this->getXmlAttributeValue($xmlNode,'template');            $this->templates[$name] = array("template" => $template,'block'=> $xmlNode);            if($xmlNode->$type != null){                $this->updateXmlTemplates($type,$xmlNode);            }        }    }    public function prepareLayout()    {        $this->siteTitle = $this->getConfig('default/site_title');        $this->siteMetaKeywords = $this->getConfig('default/site_meta_keywords');        $this->siteMetaDescription = $this->getConfig('default/site_meta_description');        $layoutXmlPath = self::$themePath . "layout/" . $this->getConfig(parent::$__area . '/layout');        $this->layoutPrepare($layoutXmlPath);        foreach ($this->handles as $handle) {            $xmlNode = $this->getLayoutXml($handle,true);            $this->prepareXmlTemplates('block',$xmlNode);        }        foreach ($this->handles as $handle) {            $xmlNode = $this->getLayoutXml($handle,true);            $this->updateXmlTemplates('reference',$xmlNode);        }        debug($this->templates);    }    public function renderLayout()    {//        debug($this->layoutXml);    }    public function renderJs()    {        $mergedJsFileName = $html = '';        parent::$_jsFiles = array_unique(parent::$_jsFiles);        if (parent::$configData['js_compress'] == 1) {            Helper::makeDir(parent::$cachePath);            $currentJsFiles['files'] = implode(",", parent::$_jsFiles);            if (file_exists(parent::$cacheJsonFile)) {                if (parent::$cachedJson === false) {                    parent::$cachedJson = Helper::readCacheFile(parent::$cacheJsonFile);                }                if (parent::$cachedJson && is_array(parent::$cachedJson) && isset(parent::$cachedJson['js'])) {                    foreach (parent::$cachedJson['js'] as $jsMergedFile) {                        if ($currentJsFiles['files'] == $jsMergedFile['files']) {                            $mergedJsFileName = $jsMergedFile['merged'];                        }                    }                }            }            if ($mergedJsFileName == '' || !file_exists(parent::$cachePath . $mergedJsFileName)) {                include_once(_BASEDIR . "lib/thidparty/jsmin.php");                $mergedJsFileName = Helper::generateRandomString() . '.js';                $jsContents = '';                foreach (parent::$_jsFiles as $jsFile) {                    if (file_exists(_BASEDIR . parent::$skinPath . $jsFile)) {                        $jsContents .= file_get_contents(_BASEDIR . parent::$skinPath . $jsFile);                    }                }                $jsContents = JSMin::minify($jsContents);                $handle = fopen(parent::$cachePath . $mergedJsFileName, 'w');                fwrite($handle, $jsContents);                fclose($handle);                $currentJsFiles['merged'] = $mergedJsFileName;                parent::$cachedJson['js'][] = $currentJsFiles;            }            $html .= sprintf('<script type="text/javascript" src="%s"></script>' . "\n",                             _BASEURL . parent::$cacheUrl . $mergedJsFileName            );        } else {            foreach (parent::$_jsFiles as $jsFile) {                if (file_exists(_BASEDIR . parent::$skinPath . $jsFile)) {                    $html .= sprintf('<script type="text/javascript" src="%s"></script>' . "\n",                                     _BASEURL . parent::$skinPath . $jsFile                    );                }            }        }        return $html;    }    public function renderCss()    {        $mergedCssFileName = $html = '';        parent::$_cssFiles = array_unique(parent::$_cssFiles);        if (parent::$configData['css_compress'] == 1) {            Helper::makeDir(parent::$cachePath);            $cssMergedFiles = array();            $currentCssFiles['files'] = implode(",", parent::$_cssFiles);            if (file_exists(parent::$cacheJsonFile)) {                if (parent::$cachedJson === false) {                    parent::$cachedJson = Helper::readCacheFile(parent::$cacheJsonFile);                }                $cssMergedFiles = parent::$cachedJson;                if (parent::$cachedJson && is_array(parent::$cachedJson) && isset(parent::$cachedJson['css'])) {                    foreach (parent::$cachedJson['css'] as $cssMergedFile) {                        if ($currentCssFiles['files'] == $cssMergedFile['files']) {                            $mergedCssFileName = $cssMergedFile['merged'];                        }                    }                }            }            if ($mergedCssFileName == '' || !file_exists(parent::$cachePath . $mergedCssFileName)) {                $mergedCssFileName = Helper::generateRandomString() . '.css';                $cssContents = '';                foreach (parent::$_cssFiles as $cssFile) {                    if (file_exists(_BASEDIR . parent::$skinPath . $cssFile)) {                        $cssContents .= file_get_contents(_BASEDIR . parent::$skinPath . $cssFile);                    }                }                $cssContents = Helper::compressCss($cssContents, _BASEURL . parent::$skinPath);                $handle = fopen(parent::$cachePath . $mergedCssFileName, 'w');                fwrite($handle, $cssContents);                fclose($handle);                $currentCssFiles['merged'] = $mergedCssFileName;                parent::$cachedJson['css'][] = $currentCssFiles;            }            $html .= sprintf('<link rel="stylesheet" type="text/css" href="%s"/>' . "\n",                             _BASEURL . parent::$cacheUrl . $mergedCssFileName            );        } else {            foreach (parent::$_cssFiles as $cssFile) {                if (file_exists(_BASEDIR . parent::$skinPath . $cssFile)) {                    $html .= sprintf('<link rel="stylesheet" type="text/css" href="%s"/>' . "\n",                                     _BASEURL . parent::$skinPath . $cssFile                    );                }            }        }        return $html;    }    public function getTheme()    {        return $this->theme;    }}